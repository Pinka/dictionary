name: Circular Dependencies Check

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: write
  contents: read

jobs:
  circular-deps-check:
    name: Check Circular Dependencies
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0  # Fetch full history to access all commits

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install ESLint and Plugins
        run: |
          npm install eslint eslint-plugin-import --save-dev

      - name: Configure ESLint
        run: |
          echo '{
            "extends": ["eslint:recommended", "plugin:import/errors", "plugin:import/warnings"],
            "plugins": ["import"],
            "rules": {
              "import/no-cycle": "error"
            }
          }' > .eslintrc.json

      - name: Debug PR context
        run: echo "PR Number: ${{ github.event.pull_request.number }} | Repo: ${{ github.repo }} | Owner: ${{ github.event.repository.owner.login }}"

      - name: Check base branch for circular dependencies
        id: base-check
        run: |
          git fetch origin +refs/pull/${{ github.event.pull_request.number }}/merge
          git checkout ${{ github.event.pull_request.base.sha }}
          npx eslint '**/*.{js,jsx,ts,tsx}' --format json > base-results.json || true
          echo "base_count=$(jq '. | length' base-results.json || echo 0)" >> $GITHUB_OUTPUT

      - name: Check PR for circular dependencies
        id: pr-check
        run: |
          git checkout ${{ github.event.pull_request.head.sha }}
          npx eslint '**/*.{js,jsx,ts,tsx}' --format json > pr-results.json || true
          echo "pr_count=$(jq '. | length' pr-results.json || echo 0)" >> $GITHUB_OUTPUT

          if [ -s pr-results.json ]; then
            echo "CYCLES<<EOF" >> $GITHUB_ENV
            cat pr-results.json >> $GITHUB_ENV  # Add ESLint results to the environment variable
            echo "EOF" >> $GITHUB_ENV
          fi

      - name: Create PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const cycles = process.env.CYCLES || '';
            const baseCount = parseInt('${{ steps.base-check.outputs.base_count }}') || 0;
            const prCount = parseInt('${{ steps.pr-check.outputs.pr_count }}') || 0;
            const difference = prCount - baseCount;

            let changeEmoji = 'ðŸŸ¡';
            let changeMessage = 'No change in circular dependencies';

            if (difference > 0) {
              changeEmoji = 'ðŸ”´';
              changeMessage = `Added ${difference} new circular dependencies`;
            } else if (difference < 0) {
              changeEmoji = 'ðŸŸ¢';
              changeMessage = `Removed ${Math.abs(difference)} circular dependencies`;
            }

            const body = `## ðŸ”„ Circular Dependencies Check
            
            ${changeEmoji} **Impact:** ${changeMessage}
            
            ${prCount > 0 ? `### Current Circular Dependencies (${prCount} total)\n\n\`\`\`\n${cycles}\n\`\`\`` : '### âœ… No Circular Dependencies Found'}
            
            ${baseCount !== prCount ? `### ðŸ“Š Changes
            - Base branch: ${baseCount} circular dependencies
            - This PR: ${prCount} circular dependencies` : ''}

            ${prCount > 0 ? '\n### ðŸ”§ Recommendations:\n' +
            '- Restructure components to avoid circular imports\n' +
            '- Move shared code to a separate module\n' +
            '- Consider using dependency injection' : ''}`;

            const issue_number = context.issue.number;

            // Log for debugging
            console.log(`Creating comment on PR #${issue_number} in ${context.repo.owner}/${context.repo.repo}`);
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: body
            });
